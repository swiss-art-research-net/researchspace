(window.webpackJsonp=window.webpackJsonp||[]).push([[149],{1244:function(e,n,t){Object.defineProperty(n,"__esModule",{value:!0});var i=t(11),o=t(1),r=t(35),a=t(0),s=t(16),d=t(33),c=t(19),l=t(162),m=t(34),u=t(23),g=t(116),p=t(56),f=t(633),I=t(1846),v=t(1847),h=t(2337),E=t(2339),R=t(2341),y=t(2340),M=t(1296),w=t(1699),b=function(e){function ImageRegionEditorComponentMirador(n,t){var i=e.call(this,n,t)||this;return i.cancellation=new m.Cancellation,i.infoQueryingCancellation=i.cancellation.derive(),i.manifestQueryingCancellation=i.cancellation.derive(),i.triggerManifestUpdatedEvent=function(e){l.trigger({eventType:R.ManifestUpdatedEvent,source:i.props.id,data:{objects:e}})},i.triggerRegionUpdatedEvent=function(e){return function(n,t){var o=t.on[0].full,r=i.state.allImages.find((function(e){return e.images.includes(o)})).objectIri,a=w.getAnnotationTextResource(t).chars;l.trigger({eventType:e,source:i.props.id,data:{objectIri:r,imageIri:o,regionIri:n.value,regionLabel:a}})}},i.onMiradorInitialized=function(e){y.scrollToRegions(e,(function(e){for(var n=e.canvasId,t=0,o=Array.from(i.state.info);t<o.length;t++){var r=o[t],a=(r[0],r[1]);if(n===a.imageIRI.value)return a.boundingBox}})),i.listenToEvents(),i.triggerManifestUpdatedEvent(i.state.allImages);var n=i.state.allImages;(n.length>1||1==n.length&&s.size(n[0].images)>1)&&e.eventEmitter.publish("TOGGLE_LOAD_WINDOW"),i.props.onMiradorInitialized&&i.props.onMiradorInitialized(e)},i.listenToEvents=function(){i.cancellation.map(l.listen({eventType:R.AddObjectImagesEvent,target:i.props.id})).observe({value:function(e){var n=i.state.allImages;if(s.some(n,(function(n){return n.objectIri===e.data.objectIri}))){i.miradorInstance.eventEmitter.one("slotsUpdated",(function(t,o){var r=o.slots,a=n.find((function(n){return n.objectIri===e.data.objectIri})),d=i.miradorInstance.viewer.manifestsPanel.manifestListItems.find((function(e){return e.manifest.jsonLd.sequences[0].canvases.some((function(e){return a.images.includes(e["@id"])}))})).manifest;i.miradorInstance.eventEmitter.publish("ADD_WINDOW",{manifest:d,slotAddress:s.last(r).layoutAddress})})),i.miradorInstance.eventEmitter.publish("SPLIT_RIGHT_FROM_WINDOW",i.miradorInstance.viewer.workspace.windows[0].id)}else{var t={objectIri:e.data.objectIri,images:e.data.imageIris};n.unshift(t),i.setState({allImages:i.state.allImages});var o=I.getIIIFServerUrl(i.props.iiifServerUrl);i.queryImagesInfo([t]).flatMap((function(n){var t=n.info,r=n.iiifImageId;return i.queryManifestParameters({infos:t,iiifImageIds:r,iri:e.data.objectIri,images:e.data.imageIris,iiifServerUrl:o})})).flatMap(h.createManifest).onValue((function(e){var t=new Mirador.Manifest(e["@id"],"",e);i.miradorInstance.eventEmitter.publish("manifestReceived",t,"Test"),i.triggerManifestUpdatedEvent(n);i.miradorInstance.eventEmitter.one("slotsUpdated",(function(e,n){var o=n.slots;i.miradorInstance.eventEmitter.publish("ADD_WINDOW",{manifest:t,slotAddress:s.last(o).layoutAddress})})),i.miradorInstance.eventEmitter.publish("SPLIT_RIGHT_FROM_WINDOW",i.miradorInstance.viewer.workspace.windows[0].id)}))}}}),i.cancellation.map(l.listen({eventType:R.RemoveRegion,target:i.props.id})).observe({value:function(e){var n=i.miradorInstance.viewer.workspace.windows.find((function(n){return n.canvasID===e.data.imageIri}));if(n){var t=n.annotationsList.find((function(n){return n["@id"]===e.data.regionIri}));i.cancellation.map(i.annotationEndpoint.remove(t)).observe({value:function(e){i.miradorInstance.eventEmitter.publish("updateAnnotationList."+n.id)}})}else i.cancellation.map(i.annotationEndpoint.search(u.Rdf.iri(e.data.imageIri)).flatMap((function(n){var t=n.find((function(n){return n["@id"]===e.data.regionIri}));return i.annotationEndpoint.remove(t)}))).observe({value:function(){}})}}),i.cancellation.map(l.listen({eventType:R.HighlightRegion,target:i.props.id})).observe({value:function(e){i.miradorInstance.eventEmitter.publish("highlightAnnotation",e.data.regionIri)}}),i.cancellation.map(l.listen({eventType:R.ZoomToRegionEvent,target:i.props.id})).observe({value:function(e){var n=i.miradorInstance.viewer.workspace.windows;if(n.find((function(n){return n.canvasID===e.data.imageIri})))i.scrollToImageRegion(e.data.imageIri,e.data.regionIri);else{i.miradorInstance.eventEmitter.one("slotsUpdated",(function(n,t){var o=t.slots;i.miradorInstance.eventEmitter.one("ANNOTATIONS_LIST_UPDATED",(function(){i.scrollToImageRegion(e.data.imageIri,e.data.regionIri)}));var r=i.miradorInstance.viewer.manifestsPanel.manifestListItems.find((function(n){var t=n.manifest;return s.some(t.jsonLd.sequences[0].canvases,(function(n){return n["@id"]===e.data.imageIri}))})).manifest;i.miradorInstance.eventEmitter.publish("ADD_WINDOW",{manifest:r,canvasID:e.data.imageIri,slotAddress:s.last(o).layoutAddress})})),i.miradorInstance.eventEmitter.publish("SPLIT_RIGHT_FROM_WINDOW",n[0].id)}}})},i.getRepositories=function(){return d.fromNullable(i.props.repositories).orElse((function(){return d.fromNullable(i.context.semanticContext).chain((function(e){return d.fromNullable([e.repository])}))})).getOrElse(["default"])},i.scrollToImageRegion=function(e,n){var t=i.miradorInstance.viewer.workspace.windows.find((function(n){return n.canvasID===e}));y.scrollToRegion(t,(function(i){var o=t.annotationsList,r=s.find(o,(function(e){return e["@id"]===n})),a=t.canvases[e].bounds,d=v.parseImageSubarea(r.on[0].selector.default.value).get();return M.computeDisplayedRegionWithMargin(d,a,.05)})).onEnd((function(){}))},i.state={loading:!0,allImages:i.normalizeImageProps(n)},i}return i.__extends(ImageRegionEditorComponentMirador,e),ImageRegionEditorComponentMirador.prototype.normalizeImageProps=function(e){var n=e.imageOrRegion;return"string"==typeof n?[{objectIri:n,images:[n]}]:Array.isArray(n)?n:s.toPairs(n).map((function(e){var n=e[0];return{images:e[1],objectIri:n}}))},ImageRegionEditorComponentMirador.prototype.componentDidMount=function(){this.queryAllImagesInfo()},ImageRegionEditorComponentMirador.prototype.shouldComponentUpdate=function(e,n){return n.loading!==this.state.loading||!s.isEqual(e,this.props)},ImageRegionEditorComponentMirador.prototype.queryAllImagesInfo=function(){var e=this;this.queryImagesInfo(this.state.allImages).observe({value:function(n){var t=n.info,i=n.iiifImageId;e.setState({loading:!1,iiifImageId:i,info:t})},error:function(n){return e.setState({loading:!1,errorMessage:n})}})},ImageRegionEditorComponentMirador.prototype.queryImagesInfo=function(e){var n=this,t=this.props.imageIdPattern,i=e.map((function(e){var i=e.images;if(!i.length)return c.constant([]);var o=i.map(u.Rdf.iri).map((function(e){return v.queryIIIFImageOrRegion(e,t,n.getRepositories()).flatMapErrors((function(){return c.constant(void 0)}))}));return c.combine(o)}));return this.infoQueryingCancellation=this.cancellation.deriveAndCancel(this.infoQueryingCancellation),this.infoQueryingCancellation.map(c.combine(i)).map((function(e){var n=new Map,t=new Map;return e.forEach((function(e){return e.forEach((function(e){e&&(n.set(e.iri.value,e),t.set(e.iri.value,e.imageId))}))})),{info:n,iiifImageId:t}}))},ImageRegionEditorComponentMirador.prototype.renderMirador=function(e){var n=this;if(this.state&&this.state.info&&e){y.removeMirador(this.miradorInstance,e);var t=I.getIIIFServerUrl(this.props.iiifServerUrl),i=this.state.allImages.map((function(e){var i=e.objectIri,r=e.images;return n.queryManifestParameters({infos:n.state.info,iiifImageIds:n.state.iiifImageId,iri:i,images:r,iiifServerUrl:t}).flatMap((function(e){var n=e.filter((function(e){return void 0!==e}));return 0===n.length?(g.addNotification({level:"error",children:o.createElement("p",{},"Images of the entity ",o.createElement(f.ResourceLinkComponent,{iri:i})," not found")}),c.constant(void 0)):(n.length<e.length&&g.addNotification({level:"warning",children:o.createElement("p",{},"Some images of the entity ",o.createElement(f.ResourceLinkComponent,{iri:i})," not found")}),h.createManifest(n))}))}));this.manifestQueryingCancellation=this.cancellation.deriveAndCancel(this.manifestQueryingCancellation),this.manifestQueryingCancellation.map(c.zip(i)).onValue((function(t){var i=t.filter((function(e){return void 0!==e})),o=n.miradorConfigFromManifest(i);n.miradorInstance=y.renderMirador({targetElement:e,miradorConfig:o,onInitialized:n.onMiradorInitialized})}))}},ImageRegionEditorComponentMirador.prototype.queryManifestParameters=function(e){var n=e.iri,t=e.images,i=e.iiifServerUrl,o=e.infos,r=e.iiifImageIds;if(!t.length)return c.constant([]);var a=t.map((function(e){var t=o.get(e),a=r.get(e);if(!t||!a)return c.constant(void 0);var s=I.constructServiceRequestUri(i,a);return I.queryImageBounds(i,a).flatMap((function(e){return c.constant({baseIri:t.isRegion?t.imageIRI:u.Rdf.iri(n),imageIri:t.imageIRI,imageServiceUri:s,canvasSize:e})})).flatMapErrors((function(){return c.constant(void 0)}))}));return c.zip(a).toProperty()},ImageRegionEditorComponentMirador.prototype.miradorConfigFromManifest=function(e){var n=this.props,t=n.id,i=n.annotationEndpoint,o=n.useDetailsSidebar,r=n.annotationViewTooltipTemplate,a=this.state.info;this.annotationEndpoint=new A(i||new E.LdpAnnotationEndpoint({imagesInfo:a}),this.triggerRegionUpdatedEvent(R.RegionCreatedEvent),this.triggerRegionUpdatedEvent(R.RegionUpdatedEvent),this.triggerRegionUpdatedEvent(R.RegionRemovedEvent));var s=e.length>1?[]:[{loadedManifest:e[0]["@id"],viewType:"ImageView",sidePanel:!1,canvasControls:{annotations:{annotationState:"on",annotationRefresh:!0}}}];return{id:t,useDetailsSidebar:o,annotationViewTooltipTemplate:r,windowSettings:{sidePanel:!o},saveSession:!1,data:e.map((function(e){return{manifestUri:e["@id"],location:"",manifestContent:e}})),annotationEndpoint:{name:"ResearchSpace annotation endpoint",module:"AdapterAnnotationEndpoint",options:{endpoint:this.annotationEndpoint}},availableAnnotationDrawingTools:["Rectangle","Ellipse","Freehand","Polygon","Pin"],windowObjects:s,annotationBodyEditor:{module:"researchspaceAnnotationBodyEditor",options:{}},jsonStorageEndpoint:{name:"Dummy JSON Storage",module:"DummyJSONStorage",options:{}}}},ImageRegionEditorComponentMirador.prototype.componentWillUnmount=function(){this.cancellation.cancelAll(),y.removeMirador(this.miradorInstance,this.miradorElement)},ImageRegionEditorComponentMirador.prototype.render=function(){var e=this,n=this.state.errorMessage;return r.div({className:"mirador",style:{position:"relative",width:"100%",height:"100%"}},n?o.createElement(g.ErrorNotification,{errorMessage:n}):r.div({ref:function(n){e.miradorElement=n,e.renderMirador(n)},id:this.props.id,className:"researchspace-mirador",style:{width:"100%",height:"100%",position:"relative"}}))},ImageRegionEditorComponentMirador.defaultProps={id:"mirador"},ImageRegionEditorComponentMirador.propTypes={imageOrRegion:a.any.isRequired,imageIdPattern:a.string.isRequired,iiifServerUrl:a.string.isRequired},ImageRegionEditorComponentMirador}(p.Component);n.ImageRegionEditorComponentMirador=b;var A=function(){function AnnotationEndpointProxy(e,n,t,i){var o=this;this.endpoint=e,this.onCreated=n,this.onUpdated=t,this.onRemoved=i,this.init=this.endpoint.init?function(){o.endpoint.init()}:void 0,this.userAuthorize=this.endpoint.userAuthorize?function(e,n){return o.endpoint.userAuthorize(e,n)}:void 0}return AnnotationEndpointProxy.prototype.search=function(e){return this.endpoint.search(e)},AnnotationEndpointProxy.prototype.create=function(e){var n=this;return this.endpoint.create(e).onValue((function(t){return n.onCreated(t,e)}))},AnnotationEndpointProxy.prototype.update=function(e){var n=this;return this.endpoint.update(e).onValue((function(t){return n.onUpdated(t,e)}))},AnnotationEndpointProxy.prototype.remove=function(e){var n=this;return this.endpoint.remove(e).onValue((function(){return n.onRemoved(u.Rdf.iri(e["@id"]),e)}))},AnnotationEndpointProxy}();n.c=b,n.f=o.createFactory(n.c),n.default=n.c},2341:function(e,n,t){Object.defineProperty(n,"__esModule",{value:!0});var i=t(162).EventMaker;n.ManifestUpdatedEvent=i("IIIFViewer.ManifestUpdated"),n.RegionCreatedEvent=i("IIIFViewer.RegionCreated"),n.RegionUpdatedEvent=i("IIIFViewer.RegionUpdated"),n.RegionRemovedEvent=i("IIIFViewer.RegionRemoved"),n.ZoomToRegionEvent=i("IIIFViewer.ZoomToRegion"),n.HighlightRegion=i("IIIFViewer.HighlightRegion"),n.RemoveRegion=i("IIIFViewer.RemoveRegion"),n.AddObjectImagesEvent=i("IIIFViewer.AddObjectImages"),n.AddImagesForObjectEvent=i("IIIFViewer.AddImagesForObject")}}]);
//# sourceMappingURL=rs-iiif-mirador-655af33e342b7333cd75.js.map