{"version":3,"sources":["webpack:///./src/main/web/components/search/facet/slider/FacetSlider.tsx","webpack:///./src/main/web/components/search/facet/slider/FacetSliderGraph.ts"],"names":["ErrorKinds","fromNumberFn","x","moment","year","startOf","dateToYears","m","dayOfYear","toStringFn","Math","abs","toSliderRange","dateRange","begin","end","fromSliderRange","range","toInputValue","num","epoch","fromInputValue","yearValue","DateConverter","numericRange","value","parseFloat","getConverter","props","fn","isDateProps","kind","isNumericProps","NumericConverter","render","className","styles","handle","style","left","this","offset","Component","onSliderValueChange","newRange","setState","onNewRange","onBeginChange","newValue","converter","state","onEndChange","isRangeValid","isValidInterval","isInRange","hasResultsInRange","min","max","_","some","events","event","validationMessage","validationError","assign","isValidRange","propsToState","debounce","gotProps","result","data","entity","push","GraphEvent","minValue","floor","map","maxValue","ceil","getOrElse","componentWillReceiveProps","nextProps","actions","toggleFacetValue","slidergraph","FacetSliderGraph","allowCross","slider","CustomHandle","onChange","FormControl","e","target","YearInput","isYearValid","FacetSliderComponent","FacetSlider","createFactory","weight","context","points","calculatePoints","indices","changes","i","scaledWeight","sort","ia","ib","n","length","currentWeight","maxWeight","j","coordinates","k","newProps","componentWillMount","componentDidMount","updateCanvas","componentDidUpdate","prevProps","prevState","canvas","findDOMNode","refs","width","clientWidth","h","height","w","ctx","getContext","beginPath","strokeStyle","lineWidth","moveTo","lineTo","stroke","setLineDash","strokeRect","round","D","div","ref"],"mappings":"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","file":"default~semantic-search-facet~semantic-search-facet-breadcrumbs-0ac3cd23b9be793a66d5.js","sourcesContent":["/**\n * ResearchSpace\n * Copyright (C) 2015-2020, Â© Trustees of the British Museum\n *\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\n/**\n * @author Denis Ostapenko\n */\n\nimport * as _ from 'lodash';\nimport * as moment from 'moment';\nimport { createFactory, Props, Component } from 'react';\nimport * as React from 'react';\nimport { FormControl } from 'react-bootstrap';\nimport { Range as Slider } from 'rc-slider';\nimport 'rc-slider/assets/index.css';\n\nimport { DateValue, DateRange, NumericRange, YearValue } from 'platform/components/semantic/search/data/search/Model';\n\nimport { YearInput } from '../../date/YearInput';\nimport { GraphEvent, FacetSliderGraph } from './FacetSliderGraph';\nimport * as styles from './FacetSlider.scss';\n\nexport type SliderRange = { begin: number; end: number };\n\ninterface FacetSliderDateProps extends Props<FacetSliderComponent> {\n  kind: 'date-range';\n  data: Array<DateRange>;\n  value: Data.Maybe<DateRange>;\n  actions: {\n    toggleFacetValue: (term: DateRange) => void;\n  };\n}\ninterface FacetSliderNumericProps extends Props<FacetSliderComponent> {\n  kind: 'numeric-range';\n  data: Array<NumericRange>;\n  value: Data.Maybe<NumericRange>;\n  actions: {\n    toggleFacetValue: (term: NumericRange) => void;\n  };\n}\ntype FacetSliderProps = FacetSliderDateProps | FacetSliderNumericProps;\nfunction isDateProps(props: FacetSliderProps): props is FacetSliderDateProps {\n  return props.kind === 'date-range';\n}\nfunction isNumericProps(props: FacetSliderProps): props is FacetSliderNumericProps {\n  return props.kind === 'numeric-range';\n}\n\nconst ErrorKinds: {\n  OutsideOfRange: 'OutsideOfRange';\n  BeginLaterThenEnd: 'BeginLaterThenEnd';\n  NoResultsInRange: 'NoResultsInRange';\n} = {\n  OutsideOfRange: 'OutsideOfRange',\n  BeginLaterThenEnd: 'BeginLaterThenEnd',\n  NoResultsInRange: 'NoResultsInRange',\n};\ntype ErrorKind =\n  | typeof ErrorKinds.OutsideOfRange\n  | typeof ErrorKinds.BeginLaterThenEnd\n  | typeof ErrorKinds.NoResultsInRange;\n\ninterface FacetSliderState {\n  min?: number;\n  max?: number;\n  isValidRange?: boolean;\n  validationError?: ErrorKind;\n  value?: SliderRange;\n  events?: GraphEvent[];\n}\n\nexport class DateConverter {\n  fromNumberFn = (x: number): DateValue => moment({ year: x }).startOf('year');\n  dateToYears = (m: DateValue): number => (m === null ? null : m.year() + (m.dayOfYear() - 1) / 366);\n\n  toStringFn = (year: number) => `${Math.abs(year)} ${year >= 0 ? 'AD' : 'BC'}`;\n  toSliderRange = (dateRange: DateRange): SliderRange => {\n    return {\n      begin: this.dateToYears(dateRange.begin),\n      end: this.dateToYears(dateRange.end),\n    };\n  };\n  fromSliderRange = (range: SliderRange): DateRange => {\n    return {\n      begin: this.fromNumberFn(range.begin),\n      end: this.fromNumberFn(range.end),\n    };\n  };\n  toInputValue = (num: number): YearValue => {\n    return {\n      epoch: num >= 0 ? 'AD' : 'BC',\n      year: Math.abs(num),\n    };\n  };\n  fromInputValue = (yearValue: YearValue): number => {\n    const { epoch, year } = yearValue;\n    return year * (epoch === 'AD' ? 1 : -1);\n  };\n}\n\nexport class NumericConverter {\n  toStringFn = (num: number): string => '' + num;\n  toSliderRange = (numericRange: NumericRange): SliderRange => numericRange;\n  fromSliderRange = (range: SliderRange): NumericRange => range;\n  toInputValue = (num: number): string => '' + num;\n  fromInputValue = (value: string): number => parseFloat(value);\n}\n\n// Trick to avoid union types in kind-related code blocks\nfunction getConverter(props, fn): any {\n  if (isDateProps(props)) {\n    return fn(props, new DateConverter());\n  } else if (isNumericProps(props)) {\n    return fn(props, new NumericConverter());\n  }\n}\n\ninterface CustomHandleProps {\n  offset?: number;\n  value?: number;\n  toStringFn: (number) => string;\n}\nclass CustomHandle extends Component<CustomHandleProps, {}> {\n  render() {\n    return (\n      <div className={styles.handle} style={{ left: this.props.offset + '%' }}>\n        {this.props.toStringFn(this.props.value)}\n      </div>\n    );\n  }\n}\n\nexport class FacetSliderComponent extends Component<FacetSliderProps, FacetSliderState> {\n  constructor(props) {\n    super(props);\n    this.state = _.assign({ isValidRange: true }, this.propsToState(props));\n    this.onNewRange = _.debounce(this.onNewRange, 500);\n  }\n\n  private propsToState(gotProps: FacetSliderProps) {\n    let result = {};\n    getConverter(gotProps, (props, converter) => {\n      let events = [];\n      for (let entity of props.data) {\n        const { begin, end } = converter.toSliderRange(entity);\n        const weight = 1.0;\n        if (begin && end) {\n          events.push(new GraphEvent(begin, end, weight));\n        }\n      }\n      const minValue = Math.floor(_.min(events.map((event) => event.begin)));\n      const maxValue = Math.ceil(_.max(events.map((event) => event.end)));\n      const value = props.value.map(converter.toSliderRange).getOrElse({ begin: minValue, end: maxValue });\n      result = { min: minValue, max: maxValue, value: value, events: events };\n    });\n    return result;\n  }\n\n  componentWillReceiveProps(nextProps: FacetSliderProps) {\n    this.setState(this.propsToState(nextProps));\n  }\n\n  onNewRange(newRange: SliderRange) {\n    if (this.isRangeValid(newRange)) {\n      getConverter(this.props, (props, converter) =>\n        props.actions.toggleFacetValue(converter.fromSliderRange(newRange))\n      );\n      this.setState({\n        isValidRange: true,\n      });\n    } else {\n      let validationError: ErrorKind;\n      if (!this.isValidInterval(newRange)) {\n        validationError = ErrorKinds.BeginLaterThenEnd;\n      } else if (!this.isInRange(newRange)) {\n        validationError = ErrorKinds.OutsideOfRange;\n      } else if (!this.hasResultsInRange(newRange)) {\n        validationError = ErrorKinds.NoResultsInRange;\n      }\n      this.setState({\n        isValidRange: false,\n        validationError: validationError,\n      });\n    }\n  }\n\n  render() {\n    const { min, max, value, isValidRange } = this.state;\n    const events = this.state.events;\n    const { toStringFn, toInputValue } = getConverter(this.props, (props, converter) => converter);\n    return (\n      <div>\n        <div className={styles.slidergraph}>\n          <FacetSliderGraph events={events} range={value} min={this.state.min} max={this.state.max} />\n          {isValidRange ? null : (\n            <div className=\"has-error\">\n              <label className=\"control-label\">{this.validationMessage()}</label>\n            </div>\n          )}\n          <Slider\n            allowCross={false}\n            min={min}\n            max={max}\n            className={styles.slider}\n            value={[value.begin, value.end]}\n            handle={(props) => <CustomHandle {...props} toStringFn={toStringFn} />}\n            onChange={this.onSliderValueChange}\n          />\n          {this.props.kind === 'numeric-range' ? (\n            <div className={styles.range}>\n              <FormControl\n                value={toInputValue(value.begin)}\n                onChange={(e) => {\n                  const newValue = (e.target as any).value;\n                  this.onBeginChange(newValue);\n                }}\n              />\n              <span>to</span>\n              <FormControl\n                value={toInputValue(value.end)}\n                onChange={(e) => {\n                  const newValue = (e.target as any).value;\n                  this.onEndChange(newValue);\n                }}\n              />\n            </div>\n          ) : (\n            <div className={styles.range}>\n              <YearInput\n                value={toInputValue(value.begin)}\n                onChange={this.onBeginChange}\n                isYearValid={this.state.isValidRange}\n              />\n              <span>to</span>\n              <YearInput\n                value={toInputValue(value.end)}\n                onChange={this.onEndChange}\n                isYearValid={this.state.isValidRange}\n              />\n            </div>\n          )}\n        </div>\n      </div>\n    );\n  }\n\n  private onSliderValueChange = (value: number[]) => {\n    const newRange = { begin: value[0], end: value[1] };\n    this.setState({ value: newRange });\n    this.onNewRange(newRange);\n  };\n\n  private onBeginChange = (newValue) => {\n    getConverter(this.props, (props, converter) => {\n      const newRange = {\n        begin: converter.fromInputValue(newValue),\n        end: this.state.value ? this.state.value.end : null,\n      };\n      this.setState({ value: newRange });\n      this.onNewRange(newRange);\n    });\n  };\n  private onEndChange = (newValue) => {\n    getConverter(this.props, (props, converter) => {\n      const newRange = {\n        begin: this.state.value ? this.state.value.begin : null,\n        end: converter.fromInputValue(newValue),\n      };\n      this.setState({ value: newRange });\n      this.onNewRange(newRange);\n    });\n  };\n\n  private isRangeValid = (range: SliderRange): boolean =>\n    this.isValidInterval(range) && this.isInRange(range) && this.hasResultsInRange(range);\n\n  private isValidInterval = (range: SliderRange): boolean => range.begin <= range.end;\n\n  private isInRange = (range: SliderRange): boolean => range.begin >= this.state.min && range.end <= this.state.max;\n\n  private hasResultsInRange = (range: SliderRange): boolean =>\n    _.some(this.state.events, (event) => event.begin <= range.end && event.end >= range.begin);\n\n  private validationMessage = (): string => {\n    const { toStringFn } = getConverter(this.props, (props, converter) => converter);\n    const { min, max } = this.state;\n    switch (this.state.validationError) {\n      case ErrorKinds.OutsideOfRange:\n        return `Available range is ${toStringFn(min)} - ${toStringFn(max)}`;\n      case ErrorKinds.BeginLaterThenEnd:\n        return 'Begin should not be later than end';\n      case ErrorKinds.NoResultsInRange:\n        return 'No results in chosen range';\n    }\n  };\n}\n\nexport const FacetSlider = createFactory(FacetSliderComponent);\nexport default FacetSlider;\n","/**\n * ResearchSpace\n * Copyright (C) 2015-2020, Â© Trustees of the British Museum\n *\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\n/**\n * @author Denis Ostapenko\n */\n\nimport { Props, Component } from 'react';\nimport * as D from 'react-dom-factories';\nimport { findDOMNode } from 'react-dom';\n\nexport class GraphEvent {\n  public begin: number;\n  public end: number;\n  public weight: number;\n\n  constructor(begin: number, end: number, weight: number) {\n    this.begin = begin;\n    this.end = end;\n    this.weight = weight;\n  }\n}\n\nexport interface FacetSliderGraphProps extends Props<FacetSliderGraph> {\n  events: GraphEvent[];\n  min: number;\n  max: number;\n  range: { begin: number; end: number };\n}\n\nexport class FacetSliderGraph extends Component<FacetSliderGraphProps, {}> {\n  private points: number[][];\n\n  constructor(props, context) {\n    super(props, context);\n    this.points = [];\n  }\n\n  private calculatePoints(events: GraphEvent[]) {\n    let indices = [];\n    let points = [];\n    let changes = [];\n    let i = 0;\n    for (let event of events) {\n      let scaledWeight = event.weight / Math.max(1, event.end - event.begin);\n      points.push(event.begin);\n      changes.push(scaledWeight);\n      indices.push(i);\n      ++i;\n      points.push(event.end);\n      changes.push(-scaledWeight);\n      indices.push(i);\n      ++i;\n    }\n    indices.sort((ia, ib) => (points[ia] - points[ib] === 0 ? changes[ib] - changes[ia] : points[ia] - points[ib]));\n    const n = points.length;\n    const min = n ? points[indices[0]] : 0;\n    const max = n ? points[indices[n - 1]] : 0;\n    let currentWeight = 0;\n    let maxWeight = 0;\n    for (let j = 0; j < n; ++j) {\n      currentWeight += changes[indices[j]];\n      if (currentWeight > maxWeight) {\n        maxWeight = currentWeight;\n      }\n    }\n    let coordinates = [];\n    currentWeight = 0;\n    for (let k = 0; k < n; ++k) {\n      coordinates.push([(points[indices[k]] - min) / (max - min), currentWeight / maxWeight]);\n      currentWeight += changes[indices[k]];\n      coordinates.push([(points[indices[k]] - min) / (max - min), currentWeight / maxWeight]);\n    }\n    // ToDo: discrete compress\n    return coordinates;\n  }\n\n  componentWillReceiveProps(newProps) {\n    if (newProps.events !== this.props.events) {\n      this.points = this.calculatePoints(newProps.events);\n    }\n  }\n\n  componentWillMount() {\n    this.points = this.calculatePoints(this.props.events);\n  }\n\n  componentDidMount() {\n    this.updateCanvas();\n  }\n\n  componentDidUpdate(prevProps, prevState) {\n    this.updateCanvas();\n  }\n\n  updateCanvas() {\n    const canvas = findDOMNode(this.refs['canvas']) as HTMLCanvasElement;\n    canvas.width = (this.refs['canvas-container'] as HTMLElement).clientWidth;\n    const h = canvas.height;\n    const w = canvas.width;\n    const ctx = canvas.getContext('2d');\n\n    // Draw graph\n    const points = this.points;\n    if (points.length > 0) {\n      ctx.beginPath();\n      ctx.strokeStyle = '#008cba';\n      ctx.lineWidth = 0.5;\n      ctx.moveTo(points[0][0] * (w - 2) + 1, h - points[0][1] * h);\n      for (let i = 1; i < points.length; ++i) {\n        ctx.lineTo(points[i][0] * (w - 2) + 1, h - points[i][1] * h);\n      }\n      ctx.stroke();\n    }\n\n    // Draw selection\n    const min = this.props.min;\n    const max = this.props.max;\n    ctx.strokeStyle = 'gray';\n    ctx.lineWidth = 1;\n    ctx.setLineDash([2, 4]);\n    ctx.strokeRect(\n      Math.round(((this.props.range.begin - min) / (max - min)) * w) + 0.5,\n      0 - 10.5,\n      Math.round(((this.props.range.end - this.props.range.begin) / (max - min)) * w),\n      h + 20\n    );\n  }\n\n  render() {\n    return D.div(\n      { ref: 'canvas-container' },\n      D.canvas({\n        ref: 'canvas',\n        width: '100%',\n        height: '100',\n      })\n    );\n  }\n}\n\nexport default FacetSliderGraph;\n"],"sourceRoot":""}