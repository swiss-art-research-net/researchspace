(window.webpackJsonp=window.webpackJsonp||[]).push([[459],{1539:function(e,n,t){Object.defineProperty(n,"__esModule",{value:!0});var o=t(11),r=t(1),i=t(1579),a=t(56),s=t(630),d=t(634),p=t(162),u=t(1845),l=t(1624),c=t(1244),g=t(3533),m=t(327),f=function(e){function ImageGraphAuthoringComponent(n,t){var o=e.call(this,n,t)||this;return o.cancellation=new d.Cancellation,o.onMiradorInitialized=function(e){o.unsubscribeFromMiradorEvents(),o.miradorInstance=e,o.subscribeOnMiradorEvents()},o.windowUpdateHandler=function(e,n){n.canvasID&&p.trigger({eventType:u.FocusOnElement,source:o.props.id,targets:[o.props.ontodiaId],data:{iri:n.canvasID}})},o.state={key:0,isLoading:!0},o.annotationEndpoint=new g.OntodiaAnnotationEndpoint({miradorId:n.id,ontodiaId:n.ontodiaId,fields:n.fields},{}),o}return o.__extends(ImageGraphAuthoringComponent,e),ImageGraphAuthoringComponent.prototype.componentDidMount=function(){var e=this,n=this.props.ontodiaId;this.cancellation.map(p.listen({eventType:p.BuiltInEvents.ComponentLoaded,source:n})).observe({value:function(){return e.setState({isLoading:!1})}}),this.cancellation.map(p.listen({eventType:u.DiagramChanged,source:n})).observe({value:function(n){var t=n.data,o=t.model,r=t.authoringState,i=e.annotationEndpoint.miradorRegions,a=e.findRegionsOnDiagram(o,r);e.shouldUpdate(i,a)&&(e.annotationEndpoint.setMiradorRegions(a),Object.keys(i).length!==Object.keys(a).length?e.setState((function(e){return{key:e.key+1}})):e.miradorInstance&&e.miradorInstance.viewer.workspace.windows.forEach((function(e){e.eventEmitter.publish("removeTooltips."+e.id),e.eventEmitter.publish("updateAnnotationList."+e.id)})))}})},ImageGraphAuthoringComponent.prototype.componentWillUnmount=function(){this.cancellation.cancelAll(),this.unsubscribeFromMiradorEvents()},ImageGraphAuthoringComponent.prototype.findRegionsOnDiagram=function(e,n){var t=this,o={};return e.elements.forEach((function(e){if(e.data.types.indexOf(l.rso.EX_Digital_Image.value)>=0&&(o[e.iri]||(o[e.iri]=[])),e.data.types.indexOf(l.rso.EX_Digital_Image_Region.value)>=0){var r=n.elements.get(e.iri);if(r&&r.deleted)return;e.links.forEach((function(n){if(n.typeId===t.props.fields.isPrimaryAreaOf&&n.sourceId===e.id){var i={region:e.data,isNew:Boolean(r)};o[n.data.targetId]?o[n.data.targetId].push(i):o[n.data.targetId]=[i]}}))}})),o},ImageGraphAuthoringComponent.prototype.shouldUpdate=function(e,n){if(Object.keys(e).length!==Object.keys(n).length)return!0;for(var t in e)if(e.hasOwnProperty(t)){var o=e[t],r=n[t];if(!r||o.length!==r.length)return!0;for(var _loop_1=function(e){if(!r.some((function(n){var t=n.region;return i.sameElement(e,t)})))return{value:!0}},a=0,s=o;a<s.length;a++){var d=_loop_1(s[a].region);if("object"==typeof d)return d.value}}return!1},ImageGraphAuthoringComponent.prototype.unsubscribeFromMiradorEvents=function(){this.miradorInstance&&this.miradorInstance.eventEmitter.unsubscribe("windowUpdated")},ImageGraphAuthoringComponent.prototype.subscribeOnMiradorEvents=function(){this.miradorInstance.eventEmitter.subscribe("windowUpdated",this.windowUpdateHandler)},ImageGraphAuthoringComponent.prototype.render=function(){var e,n=this.state,t=n.key,i=n.isLoading,a=this.annotationEndpoint.miradorRegions;if(i)return r.createElement(m.Spinner,null);if(!Object.keys(a).length)return r.createElement(s.TemplateItem,{template:{source:this.props.noImagesTemplate}});var d=((e={})["http://www.researchspace.org/ontology/Image_Graph_Authoring"]=Object.keys(a),e);return r.createElement(c.ImageRegionEditorComponentMirador,o.__assign({key:t},this.props,{imageOrRegion:d,annotationEndpoint:this.annotationEndpoint,onMiradorInitialized:this.onMiradorInitialized}))},ImageGraphAuthoringComponent.defaultProps={noImagesTemplate:"<p>No images found in the corresponding Knowledge Map.</p>"},ImageGraphAuthoringComponent}(a.Component);n.ImageGraphAuthoringComponent=f,n.default=f},3533:function(e,n,t){Object.defineProperty(n,"__esModule",{value:!0});var o=t(19),r=t(162),i=t(23),a=t(61),s=t(1845),d=t(1624),p=t(1699),u=function(){function OntodiaAnnotationEndpoint(e,n){this._miradorRegions=n,this.miradorId=e.miradorId,this.ontodiaId=e.ontodiaId,this.fields=e.fields}return Object.defineProperty(OntodiaAnnotationEndpoint.prototype,"miradorRegions",{get:function(){return this._miradorRegions},enumerable:!0,configurable:!0}),OntodiaAnnotationEndpoint.prototype.setMiradorRegions=function(e){this._miradorRegions=e},OntodiaAnnotationEndpoint.prototype.search=function(e){var n=this,t=this._miradorRegions[e.value]||[];if(!t.length)return o.constant([]);var r=t.map((function(t){var o,r=t.region,s=t.isNew,d=i.Rdf.iri(r.id);if(s){var u={annotation:d,img:e};o=prepareRegionsQuery(o=a.SparqlClient.setBindings(a.SparqlUtil.parseQuery(l),u),r.label,"label"),o=prepareRegionsQuery(o,r.properties[n.fields.value],"svgValue"),o=prepareRegionsQuery(o,r.properties[n.fields.viewport],"viewport"),o=prepareRegionsQuery(o,r.properties[n.fields.boundingBox],"boundingBox")}return p.LdpRegionService.getRegionFromSparql(d,o)}));return o.zip(r).toProperty()},OntodiaAnnotationEndpoint.prototype.create=function(e){var n=this,t=convertAnnotationToElementModel(e,this.fields);r.trigger({eventType:s.CreateElement,source:this.miradorId,targets:[this.ontodiaId],data:{elementData:t,targets:e.on.map((function(e){return{targetIri:e.full,linkTypeId:n.fields.isPrimaryAreaOf}}))}});var a=i.Rdf.iri("");return o.constant(a)},OntodiaAnnotationEndpoint.prototype.update=function(e){var n=convertAnnotationToElementModel(e,this.fields);return r.trigger({eventType:s.EditElement,source:this.miradorId,targets:[this.ontodiaId],data:{targetIri:n.id,elementData:n}}),o.constant(i.Rdf.iri(n.id))},OntodiaAnnotationEndpoint.prototype.remove=function(e){return r.trigger({eventType:s.DeleteElement,source:this.miradorId,targets:[this.ontodiaId],data:{iri:e["@id"]}}),o.constant(void 0)},OntodiaAnnotationEndpoint}();n.OntodiaAnnotationEndpoint=u;var l='prefix oa: <http://www.w3.org/ns/oa#>\nprefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\nprefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>\nprefix rso: <http://www.researchspace.org/ontology/>\nprefix dcmit: <http://purl.org/dc/dcmitype/>\nprefix cnt: <http://www.w3.org/2011/content#>\nprefix dc: <http://purl.org/dc/elements/1.1/>\nprefix crmdig: <http://www.ics.forth.gr/isl/CRMdig/>\n\nCONSTRUCT {\n?annotation a oa:Annotation ;\n    oa:motivatedBy oa:commenting ;\n    oa:hasTarget _:specificResource ;\n    oa:hasBody _:body.\n    _:body  a dcmit:Text;\n            dc:format "text/html";\n            cnt:chars ?label.\n\n    _:specificResource a oa:SpecificResource ;\n            oa:hasSource ?img ;\n            oa:hasSelector _:selector ;\n            rso:viewport ?viewport ;\n            rso:boundingBox ?boundingBox .\n\n    _:selector a oa:Choice ;\n               oa:default _:fragmentSelector ;\n               oa:item _:svgSelector .\n\n    _:svgSelector a oa:SvgSelector ;\n                  rdf:value ?svgValue .\n\n    _:fragmentSelector a oa:FragmentSelector ;\n                       rdf:value ?boundingBox .\n} WHERE {}';function convertAnnotationToElementModel(e,n){var t,o=p.getAnnotationTextResource(e);return{id:e["@id"],types:[d.rso.EX_Digital_Image_Region.value],label:{values:[{value:o.chars,language:""}]},properties:(t={},t[n.boundingBox]={type:"string",values:e.on.map((function(e){return{value:e.selector.default.value,language:""}}))},t[n.value]={type:"string",values:e.on.map((function(e){return{value:e.selector.item.value,language:""}}))},t[n.viewport]={type:"string",values:[{value:e["http://www.researchspace.org/ontology/viewport"],language:""}]},t[n.isPrimaryAreaOf]={type:"uri",values:e.on.map((function(e){return{value:e.full,type:"uri"}}))},t)}}function prepareRegionsQuery(e,n,t){return a.SparqlClient.prepareParsedQuery(n.values.map((function(e){var n,o=e.value;return(n={})[t]=i.Rdf.literal(o),n})))(e)}}}]);
//# sourceMappingURL=rs-image-graph-authoring-fc7357bad3579cd5e7fb.js.map